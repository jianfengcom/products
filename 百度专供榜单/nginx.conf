#worker_processes  4;

#Tengine SP setting
worker_processes     auto;
worker_cpu_affinity  auto;

error_log   logs/error.log crit;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;

#pid        logs/nginx.pid;


events {
    worker_connections  10240;
    use epoll;
}


http {
    include       mime.types;
    default_type  application/octet-stream;

    include nginx_logformat.conf;
    access_log  logs/access.log  tpynormal;
    #access_log  off;

    sendfile        on;
    keepalive_timeout  65;

    #add in 2011.8.6
    client_header_buffer_size  192k;
    large_client_header_buffers 4 192k;


    server_info       off; #do not show server info
    server_tokens  off;

    gzip on;
    #gzip_min_length  1k;
    gzip_buffers     4 16k;
    gzip_http_version 1.0;
    gzip_comp_level 9;
    gzip_types       application/x-javascript text/css application/xml;
    #gzip_types       text/plain application/x-javascript text/css application/xml;
    gzip_vary on;

    upstream SESSION_PDLIB {
        server 192.168.239.174:8081;
        server 192.168.239.175:8081;
        server 192.168.239.156:8081;
        server 192.168.239.157:8081;
        server 192.168.239.158:8081;
        server 192.168.239.54:8081;
        server 192.168.239.59:8081;
        ip_hash;
        hash_again  1;
    }

    upstream US_PDLIB {
        #server 192.168.239.174:8081 weight=1;
        #server 192.168.239.175:8081 weight=2;
        #server 192.168.239.156:8081 weight=2;
        #server 192.168.239.157:8081 weight=1;
        #server 192.168.239.158:8081 weight=2;
        #hash        $request_uri;
        #hash_again  8;

        server 192.168.239.174:8081 weight=2;
        server 192.168.239.175:8081 weight=2;
        server 192.168.239.156:8081 weight=2;
        server 192.168.239.157:8081 weight=1;
        server 192.168.239.158:8081 weight=2;
        server 192.168.239.54:8081 weight=2;
        server 192.168.239.59:8081 weight=2;
    }

    geo $white_ip {
        ranges;
        default 0; 
        61.145.113.28-61.145.113.28 1;
        210.21.118.144-210.21.118.144 1;
        #192.168.230.1-192.168.245.255 1;
        #192.168.216.1-192.168.219.255 1;
        120.132.50.189-120.132.50.190 1; #Ucloud proxy 
        192.168.20.1-192.168.20.255 1;
        192.168.11.254-192.168.11.254 1;
        #58.63.227.162-58.63.227.190 1; #gz proxy
        14.23.152.193-14.23.152.222 1; #gz proxy
        183.232.71.201-183.232.71.204 1; # gz mobile
        59.42.240.7-59.42.240.8 1; #gz nat IP
        14.23.114.34-14.23.114.42 1; #gz nat
    }

    limit_req_zone $http_user_agent         zone=req_ua:10m rate=200r/m;
    limit_req_zone $binary_remote_addr $uri zone=ip_uri_zone:10m rate=40r/m;
    limit_req_zone $binary_remote_addr      zone=req_ip_zone:10m rate=100r/m;
    limit_req_zone $http_x_forwarded_for    zone=req_xf_zone:10m rate=100r/m;
    limit_req_whitelist geo_var_name=white_ip geo_var_value=1;

    server {
        listen       8080;
        server_name pdlib.pconline.com.cn localhost 127.0.0.1 192.168.*;
        include nginx_ssl.conf;
        include nginx_http2https.conf;
        if ($request_uri ~ ^/product/ ){ set $sflag "${sflag}4";}
        if ($sflag = "01234") {rewrite (.*) https://$host$1 permanent;}

        #proxy_next_upstream http_500 http_503 error timeout invalid_header;
        proxy_next_upstream http_502 http_504 http_503 error timeout invalid_header;

        include nginx_deny_hack.conf;

            if ( $http_user_agent ~* (spider|bot|Yahoo\!|dita|toutiao) ) {
                rewrite (.*) /SPIDER$1 last;
            }

        location ~ ^/SPIDER {
            rewrite /SPIDER(.*) $1 break;
            limit_req zone=req_ua burst=1   nodelay;
            proxy_pass          http://US_PDLIB;
            proxy_redirect      off;
            proxy_set_header    Host             $host;
            proxy_set_header    X-Real-IP        $remote_addr;
            proxy_set_header    X-Forwarded-For  $proxy_add_x_forwarded_for;
        }

        #add in 2011
        rewrite /product/pdlib/js/online.bjk.jquery1.2.js /js/online.bjk.jquery1.2.js break;

        rewrite /readIntf.jsp(.*) /product/readIntf.jsp$1 break;

        location ~ ^/js/online.bjk.jquery1.2.js {
            expires         1d;
            root        /data/web/pdlib/product/ ;
            #error_page 404 = /errors/support.html;
        }

#        location ~ /product/outer.do\?method=alltypes {
#            #rewrite .*  http://product.pconline.com.cn/category.html permanent;
#            return 404;
#        }

        location ~ ^/product/template(\d+)/ {
	    include nginx_proto.conf;
            gzip off; #ssi need to disable gzip
	    proxy_set_header Host $host;
            proxy_set_header   X-Real-IP        $remote_addr;
            proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
            proxy_pass http://US_PDLIB;
            proxy_connect_timeout 6;
        }
	
	location ~ ^/.+/compare\.do {
	    include nginx_proto.conf;
	    if ( $query_string ~ method=(comparepic|compare) ){
		rewrite ^/.+/compare\.do  /product/service2017/compare_old_url_redirect.jsp break;
	    }
	    proxy_connect_timeout 6;
            proxy_next_upstream http_502 http_504 http_503 error timeout invalid_header;
            proxy_set_header Host $host;
            proxy_set_header   X-Real-IP        $remote_addr;
            proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
            proxy_pass     http://US_PDLIB;
	}

        location ~ ^/product/.+/pk/ {
	    include nginx_proto.conf;
            rewrite ^/product/.+/pk/picture/(\d+)_(\d+).html  /product/compare.do?method=comparepic&id=$1&id=$2 break;
	    rewrite ^/product/.+/pk/picture/(\d+)_(\d+)_(\d+).html  /product/compare.do?method=comparepic&id=$1&id=$2&id=$3 break;
	    rewrite ^/product/.+/pk/picture/(\d+)_(\d+)_(\d+)_(\d+).html  /product/compare.do?method=comparepic&id=$1&id=$2&id=$3&id=$4 break;
	    rewrite ^/product/.+/pk/picture/(\d+)_(\d+)_(\d+)_(\d+)_(\d+).html  /product/compare.do?method=comparepic&id=$1&id=$2&id=$3&id=$4&id=$5 break;

            rewrite ^/product/.+/pk/param/(\d+)_(\d+).html  /product/compare.do?method=compare&id=$1&id=$2 break;
            rewrite ^/product/.+/pk/param/(\d+)_(\d+)_(\d+).html  /product/compare.do?method=compare&id=$1&id=$2&id=$3 break;
            rewrite ^/product/.+/pk/param/(\d+)_(\d+)_(\d+)_(\d+).html  /product/compare.do?method=compare&id=$1&id=$2&id=$3&id=$4 break;
            rewrite ^/product/.+/pk/param/(\d+)_(\d+)_(\d+)_(\d+)_(\d+).html  /product/compare.do?method=compare&id=$1&id=$2&id=$3&id=$4&id=$5 break;
	    rewrite ^/product.*pk/param/(\d+).html  /product/compare.do?method=compare&id=$1 break;
            proxy_connect_timeout 6;
            proxy_next_upstream http_502 http_504 http_503 error timeout invalid_header;
            proxy_set_header Host $host;
            proxy_set_header   X-Real-IP        $remote_addr;
            proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
            proxy_pass     http://US_PDLIB;
        }

        location / {

            #limit_req   zone=ip_uri_zone  burst=40   nodelay;
            #limit_req   zone=req_ip_zone  burst=50   nodelay;
            #limit_req   zone=req_xf_zone  burst=50   nodelay;

	    include nginx_proto.conf;
	    proxy_set_header Host $host;
            proxy_set_header   X-Real-IP        $remote_addr;
            proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
            proxy_pass http://US_PDLIB;
            proxy_connect_timeout 6;
        }

        location ~* session2008.jsp { #no use
	    include nginx_proto.conf;
            proxy_set_header Host $host;
            proxy_set_header   X-Real-IP        $remote_addr;
            proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
            proxy_pass http://SESSION_PDLIB;
            proxy_connect_timeout 6;
        }

        location ~ ^/product/(visitCountToFile.jsp|pciVisitToFile.jsp) {  #add in 2011.9.8
            #limit_req   zone=ip_uri_zone  burst=40   nodelay;
            #limit_req   zone=req_ip_zone  burst=50   nodelay;
            #limit_req   zone=req_xf_zone  burst=50   nodelay;

	    include nginx_proto.conf;
            proxy_set_header Host $host;
            proxy_set_header   X-Real-IP        $remote_addr;
            proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
            proxy_pass http://SESSION_PDLIB;
            proxy_connect_timeout 6;
        }

        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }

    } #end server

server { #deny VIP visit
    server_name ~^(\d+)\.(\d+)\.(\d+)\.(\d+) ;
    listen 8080;
    return 403;
} #end server


} #end http
